<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArborGuard - Admin Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        arbor: {
                            light: '#e8f5e9',
                            DEFAULT: '#4caf50',
                            dark: '#1b5e20',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-4 md:p-10 font-sans">

    <div id="loginScreen" class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden p-8 mt-10 md:mt-20 text-center transition-all">
        <i class="fas fa-shield-alt text-6xl text-arbor mb-6 animate-pulse"></i>
        <h2 class="text-2xl font-bold text-arbor-dark mb-2">Portal Admin Tertutup</h2>
        <p class="text-gray-500 text-sm mb-8">Masukan kredensial keamanan untuk mengelola database ArborGuard.</p>
        
        <div class="mb-6 text-left">
            <input type="password" id="adminPwd" placeholder="Password Admin" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-arbor focus:border-arbor outline-none transition bg-gray-50 focus:bg-white text-gray-700">
        </div>
        <button id="loginBtnUI" class="w-full bg-arbor-dark hover:bg-green-800 text-white font-semibold py-3 px-4 rounded-xl shadow-md transition transform active:scale-95 flex justify-center items-center gap-2" onclick="login()">
            <i class="fas fa-sign-in-alt"></i> Otorisasi Akses
        </button>
    </div>

    <div id="dashboardScreen" class="hidden w-full max-w-4xl bg-white rounded-3xl shadow-xl overflow-hidden p-6 md:p-10 mb-10 transition-all">
        
        <div class="flex flex-col md:flex-row justify-between items-center border-b-2 border-arbor-light pb-6 mb-8 gap-4">
            <h2 class="text-2xl font-bold text-arbor-dark flex items-center gap-3">
                <i class="fas fa-leaf text-arbor"></i> ArborGuard Command Center
            </h2>
            <button class="bg-red-50 text-red-600 hover:bg-red-100 px-5 py-2.5 rounded-xl font-semibold transition flex items-center gap-2 shadow-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Keluar
            </button>
        </div>

        <div class="bg-gray-50 border border-gray-200 p-6 md:p-8 rounded-2xl mb-10 transition hover:shadow-md">
            <h3 id="formTitle" class="text-xl font-bold text-arbor-dark flex items-center gap-2 mb-6">
                <i class="fas fa-plus-circle"></i> Publikasi Pohon Baru
            </h3>
            <input type="hidden" id="editId">
            
            <div class="mb-5">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pohon (Sertakan nama latin)</label>
                <input type="text" id="tName" placeholder="Contoh: Pohon Ulin (Eusideroxylon zwageri)" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-arbor focus:border-arbor outline-none transition bg-white">
            </div>
            
            <div class="mb-5">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi & Status Konservasi</label>
                <textarea id="tDesc" rows="4" placeholder="Jelaskan karakteristik dan status perlindungannya..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-arbor focus:border-arbor outline-none transition bg-white"></textarea>
            </div>
            
            <div class="mb-6" id="imageInputGroup">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Unggah Gambar Resolusi Tinggi</label>
                <input type="file" id="tImage" accept="image/*" class="w-full p-3 border-2 border-dashed border-gray-300 rounded-xl bg-white cursor-pointer text-gray-500 text-sm focus:outline-none focus:ring-2 focus:ring-arbor file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-arbor-light file:text-arbor-dark hover:file:bg-green-200 transition">
            </div>
            
            <div class="flex flex-col sm:flex-row items-center gap-3 mt-8">
                <button id="saveBtn" class="w-full sm:w-auto bg-arbor-dark hover:bg-green-800 text-white font-semibold py-3 px-6 rounded-xl shadow-md transition flex items-center justify-center gap-2 transform active:scale-95" onclick="saveTree()">
                    <i class="fas fa-cloud-upload-alt"></i> Simpan Data
                </button>
                <button id="cancelBtn" class="hidden w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition flex items-center justify-center gap-2 transform active:scale-95" onclick="cancelEdit()">
                    <i class="fas fa-times"></i> Batal Edit
                </button>
            </div>
        </div>

        <div>
            <h3 class="text-xl font-bold text-arbor-dark mb-6 flex items-center gap-2">
                <i class="fas fa-database"></i> Database Flora Terlindungi
            </h3>
            <div id="adminTreeList" class="flex flex-col gap-4">
                </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('arbor_admin');
        
        if(token) showDashboard();

        async function login() {
            const pwd = document.getElementById('adminPwd').value;
            const btn = document.getElementById('loginBtnUI');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memverifikasi...';
            
            try {
                const res = await fetch('/api/admin/login', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({password: pwd}) 
                });
                if(res.ok) { 
                    localStorage.setItem('arbor_admin', pwd); 
                    showDashboard(); 
                } else { 
                    alert('Akses Ditolak: Password tidak valid!'); 
                }
            } catch (error) {
                alert('Kesalahan jaringan.');
            }
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Otorisasi Akses';
        }

        function logout() { localStorage.removeItem('arbor_admin'); location.reload(); }
        
        function showDashboard() { 
            document.getElementById('loginScreen').classList.add('hidden'); 
            document.getElementById('dashboardScreen').classList.remove('hidden'); 
            loadAdminTrees(); 
        }

        async function loadAdminTrees() {
            const list = document.getElementById('adminTreeList');
            list.innerHTML = '<div class="text-center py-10 text-gray-500 animate-pulse"><i class="fas fa-sync fa-spin text-2xl mb-2 block"></i> Memuat database...</div>';
            try {
                const res = await fetch('/api/trees', { cache: 'no-store' });
                const trees = await res.json();
                list.innerHTML = '';
                
                if(trees.length === 0) {
                    list.innerHTML = '<div class="text-center py-6 text-gray-500 bg-gray-50 rounded-xl border border-dashed border-gray-300">Belum ada data flora.</div>';
                    return;
                }

                trees.forEach(t => {
                    const shortDesc = t.description.length > 80 ? t.description.substring(0, 80) + '...' : t.description;
                    
                    // PERUBAHAN PENTING: Struktur HTML yang disuntikkan sekarang menggunakan Tailwind classes
                    list.innerHTML += `
                    <div class="flex flex-col md:flex-row justify-between md:items-center p-5 bg-white border border-gray-200 rounded-2xl hover:border-arbor hover:shadow-lg transition-all gap-4">
                        <div class="flex flex-col gap-1">
                            <div class="font-bold text-gray-800 text-lg">${t.name}</div>
                            <div class="text-sm text-gray-500 leading-relaxed">${shortDesc}</div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto justify-end shrink-0">
                            <button class="flex-1 md:flex-none bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition flex items-center justify-center gap-2 shadow-sm" onclick="editTree(${t.id}, '${t.name.replace(/'/g, "\\'")}', '${t.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="flex-1 md:flex-none bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition flex items-center justify-center gap-2 shadow-sm" onclick="deleteTree(${t.id})">
                                <i class="fas fa-trash-alt"></i> Hapus
                            </button>
                        </div>
                    </div>`;
                });
            } catch(e) {
                list.innerHTML = '<div class="text-red-500 text-center py-6 bg-red-50 rounded-xl">Gagal memuat data dari server.</div>';
            }
        }

        async function saveTree() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('tName').value;
            const desc = document.getElementById('tDesc').value;
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            btn.disabled = true;

            try {
                if(id) { 
                    await fetch(`/api/trees/${id}`, {
                        method: 'PUT', 
                        headers: {'Content-Type': 'application/json', 'Authorization': localStorage.getItem('arbor_admin')},
                        body: JSON.stringify({name, description: desc})
                    });
                    alert('Data berhasil diperbarui!'); 
                    cancelEdit();
                } else { 
                    const file = document.getElementById('tImage').files[0];
                    if(!file || !name) {
                        alert('Lengkapi Nama dan Gambar Flora!');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        return;
                    }
                    const fd = new FormData(); 
                    fd.append('name', name); fd.append('description', desc); fd.append('image', file);
                    await fetch('/api/trees', { 
                        method: 'POST', 
                        headers: {'Authorization': localStorage.getItem('arbor_admin')}, 
                        body: fd 
                    });
                    alert('Pohon berhasil ditambahkan ke database!');
                }
                
                document.getElementById('tName').value = ''; 
                document.getElementById('tDesc').value = ''; 
                document.getElementById('tImage').value = '';
                loadAdminTrees();
            } catch(error) {
                alert('Terjadi kesalahan saat menyimpan data.');
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function editTree(id, name, desc) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('formTitle').innerHTML = "<i class='fas fa-pen'></i> Perbarui Data Pohon";
            document.getElementById('editId').value = id;
            document.getElementById('tName').value = name;
            document.getElementById('tDesc').value = desc;
            document.getElementById('imageInputGroup').classList.add('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.add('flex');
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Update Data';
        }

        function cancelEdit() {
            document.getElementById('formTitle').innerHTML = "<i class='fas fa-plus-circle'></i> Publikasi Pohon Baru";
            document.getElementById('editId').value = '';
            document.getElementById('tName').value = '';
            document.getElementById('tDesc').value = '';
            document.getElementById('imageInputGroup').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.remove('flex');
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Simpan Data';
        }

        async function deleteTree(id) {
            if(confirm('Tindakan ini tidak dapat dibatalkan. Yakin ingin menghapus data flora ini?')) {
                try {
                    const res = await fetch(`/api/trees/${id}`, { 
                        method: 'DELETE', 
                        headers: {'Authorization': localStorage.getItem('arbor_admin')} 
                    });
                    
                    const data = await res.json();
                    
                    if(data.success) {
                        loadAdminTrees(); 
                    } else {
                        alert('GAGAL: ' + (data.error || 'Server menolak permintaan.'));
                    }
                } catch (error) {
                    alert('ERROR JARINGAN: Tidak dapat terhubung ke server.');
                }
            }
        }
    </script>
</body>
</html>